<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/ftp http://www.springframework.org/schema/integration/ftp/spring-integration-ftp-3.0.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.0.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<task:executor id="indexerTaskExecutor" pool-size="5"
		queue-capacity="100" rejection-policy="CALLER_RUNS" />

	<int:publish-subscribe-channel id="buildIndexChannel" />

	<int:channel id="indexRequestChannel" />
	<int:channel id="indexReplyChannel" />

	<int:gateway id="indexGateway" default-request-timeout="5000"
		default-reply-timeout="5000" default-request-channel="indexRequestChannel"
		default-reply-channel="indexReplyChannel"
		service-interface="com.wmsi.sgx.service.indexer.IndexBuilderService">
	</int:gateway>

	<int:service-activator id="alphaFactorIndexer" input-channel="buildIndexChannel" 
		ref="indexBuilderServiceImpl" method="buildAlphaFactors"/> 

	<int:header-enricher input-channel="indexRequestChannel"
		output-channel="buildIndexChannel">
		<int:header name="indexName" expression=" 'int_index_' + T(java.lang.System).currentTimeMillis()" />
		<int:header name="indexDate" expression="new java.util.Date()" />
	</int:header-enricher>

	<int:splitter id="tickerSplitter" input-channel="buildIndexChannel"
		output-channel="indexTicker" ref="indexBuilderServiceImpl" method="getTickers" />

	<int:channel id="indexTicker"
		datatype="com.wmsi.sgx.model.integration.CompanyInputRecord">
		<int:dispatcher task-executor="indexerTaskExecutor" />
	</int:channel>

	<int:service-activator id="indexBuilder"
		input-channel="indexTicker" output-channel="indexAggregator" ref="indexBuilderServiceImpl" method="index" />

	<int:aggregator 
		input-channel="indexAggregator" 
		output-channel="splitterReplyChannel"
		correlation-strategy-expression="headers.correlationId"
		release-strategy-expression="#this.size() == #this[0].headers.sequenceSize">
	</int:aggregator>
	
	<int:service-activator id="alphaFactorIndexer" input-channel="splitterReplyChannel" 
		ref="indexBuilderServiceImpl" method="createAlias"/> 

</beans>
