<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/ftp http://www.springframework.org/schema/integration/ftp/spring-integration-ftp-3.0.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.0.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<task:executor id="indexerTaskExecutor" pool-size="${loader.threads}" queue-capacity="100" rejection-policy="CALLER_RUNS" />

	<int:inbound-channel-adapter id="cronProducer" channel="indexRequestChannel"
		expression="'cronTest'">
		<int:poller cron="${loader.cron}" />
		<int:header name="jobId" expression="T(java.lang.System).currentTimeMillis()"/>
    	<int:header name="jobDate" expression="new java.util.Date()"/>
	</int:inbound-channel-adapter>
 
	<int:chain id="indexerChain" input-channel="indexRequestChannel" output-channel="loggingChannel">
		<int:header-enricher>
			<int:header name="indexName" expression=" '${elasticsearch.index.prefix}' + headers.jobId" />
			<int:header name="indexDate" expression="headers.jobDate" />
		</int:header-enricher>	
		<int:service-activator ref="indexerService" method="createIndex"/>		
		<int:service-activator ref="indexBuilderServiceImpl" method="buildAlphaFactors" />
		<int:gateway request-channel="indexChannel"/>
		<int:service-activator ref="indexerService" method="createIndexAlias" />		
	</int:chain>

	<int:chain id="indexSplitterChain" input-channel="indexChannel" output-channel="indexTicker">
		<int:splitter ref="indexBuilderServiceImpl" method="getTickers"/>
	</int:chain>
	
	<int:chain id="indexBuilderChain" input-channel="indexTicker" >
		<int:service-activator ref="indexBuilderServiceImpl" method="index" />
		
		<int:aggregator 
			correlation-strategy-expression="headers.correlationId"
			release-strategy-expression="#this.size() == #this[0].headers.sequenceSize">
		</int:aggregator>
	</int:chain>


	<!--  Channel definitions -->
	<int:channel id="indexRequestChannel"/>

	<int:channel id="indexTicker" datatype="com.wmsi.sgx.model.integration.CompanyInputRecord">
		<int:dispatcher task-executor="indexerTaskExecutor" />
	</int:channel>

	<int:channel id="loggingChannel"/>
	
	<int:logging-channel-adapter channel="loggingChannel" level="INFO" />

</beans>
